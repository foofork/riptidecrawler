# ============================================================================
# RipTide Minimal - Zero-Dependency Deployment
# ============================================================================
# MINIMAL SETUP with NO external dependencies:
#   ✅ Single RipTide API container
#   ✅ In-memory cache (no Redis)
#   ✅ No background workers
#   ✅ No headless browser service (WASM rendering only)
#   ✅ 440MB memory footprint
#
# Perfect for:
#   - Local development and testing
#   - CI/CD integration tests
#   - Simple extraction tasks (1-100 URLs)
#   - Learning and experimentation
#
# Quick Start:
#   docker-compose -f docker-compose.minimal.yml up -d
#   docker-compose -f docker-compose.minimal.yml logs -f
#   docker-compose -f docker-compose.minimal.yml down
#
# What's Different from Full Deployment:
#   ❌ No Redis (uses in-memory cache with 3600s TTL)
#   ❌ No background workers (synchronous execution)
#   ❌ No headless browser (WASM extraction only)
#   ❌ Cache clears on restart
#   ❌ No persistent sessions
#   ⚠️ Not suitable for high-volume production workloads
#
# Resource Requirements:
#   - Memory: ~440MB
#   - CPU: 0.5-2.0 cores
#   - Disk: Minimal (logs only)
# ============================================================================

version: '3.8'

services:
  # =========================================================================
  # RipTide API - Standalone minimal deployment
  # =========================================================================
  riptide-api:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.api
      target: runtime
      args:
        - BUILDKIT_INLINE_CACHE=1
      cache_from:
        - riptide-api:latest
    image: riptide-api:latest
    container_name: riptide-minimal
    restart: unless-stopped

    ports:
      - "${RIPTIDE_API_PORT:-8080}:8080"

    environment:
      # Core configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # API configuration
      - RIPTIDE_API_HOST=0.0.0.0
      - RIPTIDE_API_PORT=8080
      - RIPTIDE_API_KEY=${RIPTIDE_API_KEY}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-false}

      # Cache: In-memory only (no Redis)
      - CACHE_BACKEND=memory
      - CACHE_MEMORY_TTL=3600
      - CACHE_MAX_ENTRIES=10000

      # Workers: Disabled (synchronous execution)
      - WORKERS_ENABLED=false

      # Spider: Enabled (works without Redis)
      - SPIDER_ENABLE=${SPIDER_ENABLE:-true}

      # Output directories (container paths)
      - RIPTIDE_OUTPUT_DIR=/opt/riptide/data
      - RIPTIDE_CACHE_DIR=/opt/riptide/cache
      - RIPTIDE_LOGS_DIR=/opt/riptide/logs

      # Search configuration (optional)
      - SEARCH_BACKEND=${SEARCH_BACKEND:-none}
      - SERPER_API_KEY=${SERPER_API_KEY}

      # LLM configuration (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Resource limits (reduced for minimal mode)
      - RIPTIDE_MAX_CONCURRENT_REQUESTS=${RIPTIDE_MAX_CONCURRENT_REQUESTS:-50}
      - RIPTIDE_POOL_SIZE=${RIPTIDE_POOL_SIZE:-4}

    # Mount minimal configuration
    volumes:
      # Persistent data volumes (optional)
      - riptide-minimal-data:/opt/riptide/data
      - riptide-minimal-cache:/opt/riptide/cache
      - riptide-minimal-logs:/opt/riptide/logs

      # Use minimal configuration
      - ./config/deployment/minimal.toml:/opt/riptide/config/deployment/minimal.toml:ro

    # No network dependencies
    network_mode: bridge

    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Reduced resource limits for minimal deployment
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    labels:
      - "description=RipTide Minimal - No external dependencies"
      - "use_case=Development, CI/CD, simple extraction"
      - "deployment_mode=minimal"
      - "cache=in-memory"
      - "workers=disabled"
      - "browser=none"


# =============================================================================
# Volumes - Minimal persistent storage
# =============================================================================
volumes:
  riptide-minimal-data:
    driver: local
  riptide-minimal-cache:
    driver: local
  riptide-minimal-logs:
    driver: local


# =============================================================================
# NOTES
# =============================================================================
# 1. NO REDIS: All caching is in-memory and will be cleared on restart
# 2. NO WORKERS: All requests are processed synchronously
# 3. NO BROWSER: Only WASM extraction (fast for static content)
# 4. For production workloads, use: docker-compose.yml
# 5. For development with Redis, use: docker-compose.simple.yml
#
# Upgrade Path:
#   Minimal → Simple (add Redis) → Distributed (add workers + browsers)
#
# To switch to simple mode:
#   docker-compose -f docker-compose.minimal.yml down
#   docker-compose -f docker-compose.simple.yml up -d
# =============================================================================
