name: CI/CD Metrics Collection

on:
  # Run nightly to track performance trends
  schedule:
    - cron: "0 2 * * *"  # 2 AM UTC daily
  workflow_dispatch:

# serialize per-branch so metrics stay coherent
concurrency:
  group: metrics-${{ github.ref }}
  cancel-in-progress: false

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTC_WRAPPER: sccache

jobs:
  collect-metrics:
    name: Build & Test Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev pkg-config bc time jq

      - name: sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Cargo cache
        id: cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "metrics-cache"

      - name: Prepare metrics dir & headers
        run: |
          mkdir -p metrics
          [ -f metrics/cache_hits.csv ] || echo "timestamp,cache_hit" > metrics/cache_hits.csv
          [ -f metrics/build_metrics.csv ] || echo "timestamp,duration_s,status,type,max_rss_kb" > metrics/build_metrics.csv
          [ -f metrics/test_metrics.csv ] || echo "timestamp,duration_s,status,type,max_rss_kb" > metrics/test_metrics.csv
          [ -f metrics/sccache_stats_before.txt ] || true
          [ -f metrics/sccache_stats_after.txt ] || true

      - name: Record cache status
        run: |
          echo "$(date -Iseconds),${{ steps.cache.outputs.cache-hit }}" >> metrics/cache_hits.csv
          echo "Cache hit: ${{ steps.cache.outputs.cache-hit }}"

      - name: sccache stats (before)
        run: sccache --show-stats | tee metrics/sccache_stats_before.txt || true

      - name: Track build time (workspace release)
        id: build
        env:
          RUSTFLAGS: "-Dwarnings"
        run: |
          echo "Starting build: $(date -Iseconds)"
          START=$(date +%s)
          # Measure wall time + peak RSS
          (/usr/bin/time -v cargo build --workspace --all-targets --release) \
            > build.log 2> build.time || BUILD_STATUS="failed"
          END=$(date +%s)
          DUR=$((END-START))
          MAXRSS=$(grep "Maximum resident set size" build.time | awk '{print $6}' || echo "0")
          echo "BUILD_STATUS=${BUILD_STATUS:-success}" >> $GITHUB_ENV
          echo "BUILD_TIME=$DUR" >> $GITHUB_ENV
          echo "BUILD_MAXRSS_KB=$MAXRSS" >> $GITHUB_ENV
          echo "$(date -Iseconds),$DUR,${BUILD_STATUS:-success},full,$MAXRSS" >> metrics/build_metrics.csv
          echo "Build: ${DUR}s, peak ${MAXRSS} KB, status ${BUILD_STATUS:-success}"

      - name: Track WASM build time
        if: env.BUILD_STATUS == 'success'
        run: |
          rustup target add wasm32-wasip2
          START=$(date +%s)
          (/usr/bin/time -v cargo build --release --target wasm32-wasip2 -p riptide-extractor-wasm) \
            > wasm_build.log 2> wasm_build.time || WASM_STATUS="failed"
          END=$(date +%s)
          DUR=$((END-START))
          MAXRSS=$(grep "Maximum resident set size" wasm_build.time | awk '{print $6}' || echo "0")
          echo "WASM_TIME=$DUR" >> $GITHUB_ENV
          echo "$(date -Iseconds),$DUR,${WASM_STATUS:-success},wasm,$MAXRSS" >> metrics/build_metrics.csv
          echo "WASM: ${DUR}s, peak ${MAXRSS} KB, status ${WASM_STATUS:-success}"

      - name: Install nextest (faster tests)
        if: env.BUILD_STATUS == 'success'
        uses: taiki-e/install-action@nextest

      - name: Track test time (unit)
        if: env.BUILD_STATUS == 'success'
        run: |
          START=$(date +%s)
          (/usr/bin/time -v cargo nextest run --workspace --all-features --lib --bins --failure-output=immediate --retries=1 --test-threads=4) \
            > test_unit.log 2> test_unit.time || TEST_STATUS="failed"
          END=$(date +%s)
          DUR=$((END-START))
          MAXRSS=$(grep "Maximum resident set size" test_unit.time | awk '{print $6}' || echo "0")
          echo "$(date -Iseconds),$DUR,${TEST_STATUS:-success},unit,$MAXRSS" >> metrics/test_metrics.csv
          echo "Unit tests: ${DUR}s, peak ${MAXRSS} KB, status ${TEST_STATUS:-success}"

      - name: Track test time (integration)
        if: env.BUILD_STATUS == 'success'
        run: |
          START=$(date +%s)
          (/usr/bin/time -v cargo nextest run --workspace --all-features --tests --failure-output=immediate --retries=1 --test-threads=2) \
            > test_integration.log 2> test_integration.time || TEST_STATUS="failed"
          END=$(date +%s)
          DUR=$((END-START))
          MAXRSS=$(grep "Maximum resident set size" test_integration.time | awk '{print $6}' || echo "0")
          echo "$(date -Iseconds),$DUR,${TEST_STATUS:-success},integration,$MAXRSS" >> metrics/test_metrics.csv
          echo "Integration tests: ${DUR}s, peak ${MAXRSS} KB, status ${TEST_STATUS:-success}"

      - name: sccache stats (after)
        run: sccache --show-stats | tee metrics/sccache_stats_after.txt || true

      - name: Resource snapshot
        if: always()
        run: |
          {
            echo "=== Resource Usage Summary ==="
            echo "Timestamp: $(date -Iseconds)"
            echo
            echo "[Memory]";  free -h || true
            echo; echo "[Disk]"; df -h | grep -E "(Filesystem|/dev/root)" || true
            echo; echo "[target size]"; du -sh target/ 2>/dev/null || echo "N/A"
          } | tee metrics/resource_usage.log

      - name: Summary
        if: always()
        run: |
          echo "# CI/CD Metrics Report" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${BUILD_TIME:-}" ]; then
            echo "## Build" >> $GITHUB_STEP_SUMMARY
            echo "- Full build: $((BUILD_TIME/60))m $((BUILD_TIME%60))s (status: ${BUILD_STATUS:-unknown})" >> $GITHUB_STEP_SUMMARY
            echo "- Peak RSS: ${BUILD_MAXRSS_KB:-0} KB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${WASM_TIME:-}" ]; then
            echo "## WASM" >> $GITHUB_STEP_SUMMARY
            echo "- Build: $((WASM_TIME/60))m $((WASM_TIME%60))s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Cache" >> $GITHUB_STEP_SUMMARY
          echo "- rust-cache hit: ${{ steps.cache.outputs['cache-hit'] }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Recent Build Rows" >> $GITHUB_STEP_SUMMARY
          echo '```csv' >> $GITHUB_STEP_SUMMARY
          echo "timestamp,duration_s,status,type,max_rss_kb" >> $GITHUB_STEP_SUMMARY
          tail -5 metrics/build_metrics.csv >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics-${{ github.sha }}
          path: |
            metrics/
            build.log
            build.time
            wasm_build.log
            wasm_build.time
            test_unit.log
            test_unit.time
            test_integration.log
            test_integration.time
          retention-days: 30

      - name: Commit metrics to repo (main only)
        if: github.ref == 'refs/heads/main' && always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add metrics/ || true
          git commit -m "chore(metrics): update CI/CD metrics [skip ci]" || echo "No changes"
          git push || echo "No changes to push"
