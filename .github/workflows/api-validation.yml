name: API Validation Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/api/openapi.yaml'
      - 'crates/riptide-api/**'
      - 'tests/api/**'
      - '.github/workflows/api-validation.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/api/openapi.yaml'
      - 'crates/riptide-api/**'
      - 'tests/api/**'
      - '.github/workflows/api-validation.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUST_LOG: warn

jobs:
  static-analysis:
    name: üîç Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      RUSTFLAGS: "-Dwarnings"
      RUSTC_WRAPPER: sccache
    steps:
      - uses: actions/checkout@v4

      - uses: mozilla-actions/sccache-action@v0.0.6

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "api-validation"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check formatting
        run: cargo fmt --package riptide-api -- --check

      - name: Clippy (zero warnings)
        run: cargo clippy --package riptide-api --all-targets -- -D warnings

      - name: Validate OpenAPI (spectral + swagger-cli)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm i -g @apidevtools/swagger-cli @stoplight/spectral-cli
      - run: |
          swagger-cli validate docs/api/openapi.yaml
          spectral lint docs/api/openapi.yaml --format stylish --fail-severity error

  contract-validation:
    name: üìã Contract Validation (Dredd)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [static-analysis]
    env:
      RUSTC_WRAPPER: sccache
    services:
      redis:
        image: redis:7-alpine
        ports: [ "6379:6379" ]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: mozilla-actions/sccache-action@v0.0.6
      - uses: Swatinem/rust-cache@v2
      - uses: dtolnay/rust-toolchain@stable

      - name: Install WASM target
        run: rustup target add wasm32-wasip2

      - name: System deps
        run: sudo apt-get update && sudo apt-get install -y libfontconfig1-dev pkg-config redis-tools

      - name: Build WASM extractor
        run: cargo build --release --target wasm32-wasip2 -p riptide-extractor-wasm

      - name: Build API
        env: { RUSTFLAGS: "-Dwarnings" }
        run: cargo build --release -p riptide-api

      - name: Start API
        env:
          REDIS_URL: redis://localhost:6379
          RUST_LOG: info,riptide_api=debug,riptide_core=debug,cranelift=warn,cranelift_codegen=warn,wasmtime=warn
          RUST_BACKTRACE: full
          API_HOST: 0.0.0.0
          API_PORT: 8080
          WASM_EXTRACTOR_PATH: target/wasm32-wasip2/release/riptide_extractor_wasm.wasm
          REQUIRE_AUTH: "false"
        run: |
          set -e
          BINARY_PATH=$(cargo metadata --format-version=1 | jq -r '.target_directory')/release/riptide-api || true
          [ -x "$BINARY_PATH" ] || BINARY_PATH=$(find target -name riptide-api -type f -executable | head -1)
          [ -f "$WASM_EXTRACTOR_PATH" ] || { echo "‚ùå missing WASM"; exit 1; }
          redis-cli -h localhost -p 6379 ping >/dev/null || { echo "‚ùå redis"; exit 1; }
          stdbuf -oL -eL "$BINARY_PATH" > api.log 2>&1 &
          echo "API_PID=$!" >> $GITHUB_ENV
          for i in {1..30}; do curl -sf http://localhost:8080/healthz && break; sleep 2; done
          curl -sf http://localhost:8080/healthz || { echo "‚ùå health"; tail -100 api.log; exit 1; }

      - name: Dredd
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Run Dredd contract tests
        continue-on-error: true
        run: |
          npm i -g dredd
          dredd docs/api/openapi.yaml http://localhost:8080 \
            --reporter=html --reporter=markdown \
            --output=dredd-report.html --output=dredd-report.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contract-artifacts
          path: |
            dredd-report.*
            api.log

      - name: Stop API
        if: always()
        run: kill ${{ env.API_PID }} || true

  fuzzing-tests:
    name: üîÄ Fuzzing (Schemathesis)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [static-analysis]
    env:
      RUSTC_WRAPPER: sccache
    services:
      redis:
        image: redis:7-alpine
        ports: [ "6379:6379" ]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: mozilla-actions/sccache-action@v0.0.6
      - uses: Swatinem/rust-cache@v2
      - uses: dtolnay/rust-toolchain@stable
      - run: rustup target add wasm32-wasip2
      - run: sudo apt-get update && sudo apt-get install -y libfontconfig1-dev pkg-config redis-tools
      - run: cargo build --release --target wasm32-wasip2 -p riptide-extractor-wasm
      - run: cargo build --release -p riptide-api

      - name: Start API (health wait)
        env:
          REDIS_URL: redis://localhost:6379
          API_PORT: 8080
          WASM_EXTRACTOR_PATH: target/wasm32-wasip2/release/riptide_extractor_wasm.wasm
          REQUIRE_AUTH: "false"
        run: |
          BINARY_PATH=$(find target -name riptide-api -type f -executable | head -1)
          stdbuf -oL -eL "$BINARY_PATH" > api.log 2>&1 & echo "API_PID=$!" >> $GITHUB_ENV
          for i in {1..30}; do curl -sf http://localhost:8080/healthz && break; sleep 2; done
          curl -sf http://localhost:8080/healthz || { echo "‚ùå health"; tail -100 api.log; exit 1; }

      - uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Schemathesis
        run: |
          pip install --upgrade pip
          pip install schemathesis
          schemathesis run docs/api/openapi.yaml \
            --url http://localhost:8080 \
            --checks all --max-examples=100

      - name: Upload fuzz artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzzing-artifacts
          path: api.log

      - name: Stop API
        if: always()
        run: kill ${{ env.API_PID }} || true

  validation-complete:
    name: ‚úÖ Validation Complete
    runs-on: ubuntu-latest
    needs: [static-analysis, contract-validation, fuzzing-tests]
    if: always()
    steps:
      - run: |
          echo "Static: ${{ needs.static-analysis.result }}"
          echo "Dredd:  ${{ needs.contract-validation.result }}"
          echo "Fuzz:   ${{ needs.fuzzing-tests.result }}"
          if [ "${{ needs.static-analysis.result }}" != "success" ] || \
             [ "${{ needs.contract-validation.result }}" != "success" ] || \
             [ "${{ needs.fuzzing-tests.result }}" != "success" ]; then
            exit 1
          fi
