name: Docker Build & Publish

# Separate Docker workflow - only runs when needed:
# - Manual trigger (workflow_dispatch)
# - Main branch pushes
# - Release tags

on:
  push:
    tags: ["v*"]
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: "Push to Docker registry"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build binaries first (reusable for Docker)
  build-artifacts:
    name: Build Release Artifacts (${{ matrix.variant }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run if CI workflow succeeded (or manual/tag trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    strategy:
      fail-fast: false
      matrix:
        variant:
          - native  # Fast builds without WASM (default for PRs)
          - wasm    # Full build with WASM (for main/releases)
        include:
          # WASM variant only on main branch, tags, or workflow_dispatch
          - variant: wasm
    steps:
      - uses: actions/checkout@v4

      # OPTIMIZATION: Try to download artifacts from CI workflow first
      - name: Download artifacts from CI workflow
        id: download-ci-artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: build-artifacts-${{ matrix.variant == 'wasm' && 'wasm32-wasip2' || 'native' }}
          path: target/release
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify downloaded artifacts
        id: check-artifacts
        run: |
          if [ -f "target/release/riptide-api" ] && [ -f "target/release/riptide-headless" ] && [ -f "target/release/riptide-workers" ]; then
            echo "‚úÖ Using artifacts from CI workflow (saves 15-20 minutes!)"
            echo "has-artifacts=true" >> $GITHUB_OUTPUT
            ls -lh target/release/riptide-*
          else
            echo "‚ö†Ô∏è  No CI artifacts found, will build from scratch"
            echo "has-artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust environment
        if: steps.check-artifacts.outputs.has-artifacts != 'true'
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{ matrix.variant == 'wasm' && 'wasm32-wasip2' || '' }}
          shared-key: docker-build-cache-${{ matrix.variant }}

      - name: Build native binaries (${{ matrix.variant }} variant)
        if: |
          steps.check-artifacts.outputs.has-artifacts != 'true' &&
          (matrix.variant == 'native' ||
           github.ref == 'refs/heads/main' ||
           github.event_name == 'workflow_dispatch' ||
           startsWith(github.ref, 'refs/tags/v'))
        env:
          RUSTFLAGS: "-C target-cpu=x86-64-v2"
        run: |
          echo "üî® Building native release binaries (${{ matrix.variant }} variant)..."

          if [ "${{ matrix.variant }}" = "native" ]; then
            echo "Building with native-parser only (no WASM, 40% faster)..."
            cargo build --release -p riptide-api --no-default-features --features native-parser
          else
            echo "Building with WASM support..."
            cargo build --release -p riptide-api --features wasm-extractor
          fi

          cargo build --release -p riptide-headless
          cargo build --release -p riptide-workers

          # Ensure binaries are in standard location
          if [ -f "target/x86_64-unknown-linux-gnu/release/riptide-api" ]; then
            mkdir -p target/release
            cp target/x86_64-unknown-linux-gnu/release/riptide-{api,headless,workers} target/release/
          fi

          echo "‚úÖ Binaries built:"
          ls -lh target/release/riptide-*

      - name: Build WASM component
        if: |
          matrix.variant == 'wasm' &&
          (github.ref == 'refs/heads/main' ||
           github.event_name == 'workflow_dispatch' ||
           startsWith(github.ref, 'refs/tags/v'))
        run: |
          echo "üî® Building WASM component..."
          cargo build --release --target wasm32-wasip2 -p riptide-extractor-wasm

          mkdir -p wasm-dist
          cp target/wasm32-wasip2/release/*.wasm wasm-dist/

          echo "‚úÖ WASM built:"
          ls -lh wasm-dist/

      - name: Upload native artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-binaries-${{ matrix.variant }}
          path: |
            target/release/riptide-api
            target/release/riptide-headless
            target/release/riptide-workers
          retention-days: 3
          if-no-files-found: error

      - name: Upload WASM artifacts
        if: matrix.variant == 'wasm'
        uses: actions/upload-artifact@v4
        with:
          name: wasm-binaries
          path: wasm-dist/*.wasm
          retention-days: 3
          if-no-files-found: error

  # Build Docker images in parallel (both native and WASM variants for API)
  docker-build:
    name: Build ${{ matrix.service }} Image (${{ matrix.variant || 'default' }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-artifacts
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        service: [api, headless]
        variant: [native]  # Default to native-only builds
        include:
          # Add WASM variant for API on main/releases only
          - service: api
            variant: wasm
            enable_wasm: true
        exclude:
          # Headless doesn't use extraction, always native
          - service: headless
            variant: wasm
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:buildx-stable-1

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          name: native-binaries-${{ matrix.variant }}
          path: artifacts/

      - name: Download WASM artifacts (API WASM variant only)
        if: matrix.service == 'api' && matrix.variant == 'wasm'
        uses: actions/download-artifact@v4
        with:
          name: wasm-binaries
          path: wasm-dist/

      - name: Verify artifacts
        run: |
          echo "üì¶ Verifying build artifacts (${{ matrix.variant }} variant)..."
          ls -lh artifacts/
          if [ "${{ matrix.service }}" = "api" ] && [ "${{ matrix.variant }}" = "wasm" ]; then
            echo "WASM artifacts:"
            ls -lh wasm-dist/ || echo "No WASM artifacts (expected for native variant)"
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch,suffix=-${{ matrix.variant }}
            type=ref,event=pr,suffix=-${{ matrix.variant }}
            type=semver,pattern={{version}},suffix=-${{ matrix.variant }}
            type=semver,pattern={{major}}.{{minor}},suffix=-${{ matrix.variant }}
            type=sha,prefix={{branch}}-${{ matrix.variant }}-
            type=raw,value=latest-${{ matrix.variant }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && matrix.variant == 'native' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.${{ matrix.service }}
          push: ${{ github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) || inputs.push_to_registry }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-${{ matrix.variant }}
          platforms: linux/amd64
          build-args: |
            ENABLE_WASM=${{ matrix.variant == 'wasm' && 'true' || 'false' }}

      - name: Export image for testing
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.${{ matrix.service }}
          tags: riptide-${{ matrix.service }}:test-${{ matrix.variant }}
          cache-from: type=gha,scope=${{ matrix.service }}-${{ matrix.variant }}
          outputs: type=docker,dest=/tmp/riptide-${{ matrix.service }}-${{ matrix.variant }}.tar
          build-args: |
            ENABLE_WASM=${{ matrix.variant == 'wasm' && 'true' || 'false' }}

      - name: Upload image artifact (PRs only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}-${{ matrix.variant }}
          path: /tmp/riptide-${{ matrix.service }}-${{ matrix.variant }}.tar
          retention-days: 1

  # Validate Docker images work
  docker-test:
    name: Test ${{ matrix.service }} Image (${{ matrix.variant }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: docker-build
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        service: [api, headless]
        variant: [native]  # Only test native variant in PRs for speed
    steps:
      - name: Download image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.service }}-${{ matrix.variant }}
          path: /tmp

      - name: Load and test image
        run: |
          docker load -i /tmp/riptide-${{ matrix.service }}-${{ matrix.variant }}.tar
          echo "‚úÖ Image loaded successfully (${{ matrix.variant }} variant)"

          # Basic smoke test
          docker run --rm riptide-${{ matrix.service }}:test-${{ matrix.variant }} --version || true
          echo "‚úÖ Image runs (${{ matrix.variant }} variant)"

  # Summary
  docker-complete:
    name: Docker Build Complete
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "‚ùå Docker build failed"
            exit 1
          fi

          echo "‚úÖ Docker images built successfully"

          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "üì¶ Images pushed to ${{ env.REGISTRY }}"
          fi
