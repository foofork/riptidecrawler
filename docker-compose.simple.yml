# ============================================================================
# RipTide Simple - API + Redis (No Workers)
# ============================================================================
# SIMPLE DEPLOYMENT with Redis caching:
#   ✅ RipTide API container
#   ✅ Redis for persistent caching
#   ✅ No background workers (synchronous execution)
#   ✅ No headless browser service (WASM rendering only)
#   ✅ ~600MB memory footprint
#
# Perfect for:
#   - Development with persistent cache
#   - Small-scale production (< 1000 requests/day)
#   - Testing with real caching infrastructure
#   - API integration development
#
# Quick Start:
#   docker-compose -f docker-compose.simple.yml up -d
#   docker-compose -f docker-compose.simple.yml logs -f
#   docker-compose -f docker-compose.simple.yml down
#
# What's Different:
#   ✅ Redis for persistent caching (survives restarts)
#   ✅ Cache TTL and LRU eviction
#   ❌ No background workers (synchronous execution)
#   ❌ No headless browser (WASM extraction only)
#   ⚠️ Limited by single API instance performance
#
# Upgrade Path:
#   To add workers and browsers: docker-compose.yml
#   To remove Redis: docker-compose.minimal.yml
#
# Resource Requirements:
#   - Memory: ~600MB (API: 440MB, Redis: 160MB)
#   - CPU: 1.0-2.5 cores
#   - Disk: Redis persistence (~100MB)
# ============================================================================

version: '3.8'

services:
  # =========================================================================
  # RipTide API - With Redis caching
  # =========================================================================
  riptide-api:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.api
      target: runtime
      args:
        - BUILDKIT_INLINE_CACHE=1
      cache_from:
        - riptide-api:latest
    image: riptide-api:latest
    container_name: riptide-simple
    restart: unless-stopped

    ports:
      - "${RIPTIDE_API_PORT:-8080}:8080"

    environment:
      # Core configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # API configuration
      - RIPTIDE_API_HOST=0.0.0.0
      - RIPTIDE_API_PORT=8080
      - RIPTIDE_API_KEY=${RIPTIDE_API_KEY}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-false}

      # Cache: Redis backend
      - CACHE_BACKEND=redis
      - REDIS_URL=redis://redis:6379/0

      # Workers: Disabled (synchronous execution)
      - WORKERS_ENABLED=false

      # Spider: Enabled (works with Redis)
      - SPIDER_ENABLE=${SPIDER_ENABLE:-true}

      # Output directories
      - RIPTIDE_OUTPUT_DIR=/opt/riptide/data
      - RIPTIDE_CACHE_DIR=/opt/riptide/cache
      - RIPTIDE_LOGS_DIR=/opt/riptide/logs

      # Search configuration (optional)
      - SEARCH_BACKEND=${SEARCH_BACKEND:-none}
      - SERPER_API_KEY=${SERPER_API_KEY}

      # LLM configuration (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Resource limits
      - RIPTIDE_MAX_CONCURRENT_REQUESTS=${RIPTIDE_MAX_CONCURRENT_REQUESTS:-100}
      - RIPTIDE_POOL_SIZE=${RIPTIDE_POOL_SIZE:-8}

    volumes:
      - riptide-simple-data:/opt/riptide/data
      - riptide-simple-cache:/opt/riptide/cache
      - riptide-simple-logs:/opt/riptide/logs

    networks:
      - riptide-simple-network

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    labels:
      - "description=RipTide Simple - API with Redis caching"
      - "use_case=Development, small production workloads"
      - "deployment_mode=simple"
      - "cache=redis"
      - "workers=disabled"
      - "browser=none"


  # =========================================================================
  # Redis - Caching and session storage
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: riptide-simple-redis
    restart: unless-stopped

    ports:
      - "${REDIS_PORT:-6379}:6379"

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

    volumes:
      - redis-simple-data:/data

    networks:
      - riptide-simple-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    labels:
      - "description=Redis cache for RipTide Simple"


# =============================================================================
# Networks
# =============================================================================
networks:
  riptide-simple-network:
    driver: bridge


# =============================================================================
# Volumes - Persistent storage
# =============================================================================
volumes:
  riptide-simple-data:
    driver: local
  riptide-simple-cache:
    driver: local
  riptide-simple-logs:
    driver: local
  redis-simple-data:
    driver: local


# =============================================================================
# NOTES
# =============================================================================
# 1. REDIS: Persistent caching survives container restarts
# 2. NO WORKERS: All requests processed synchronously
# 3. NO BROWSER: Only WASM extraction (fast for static content)
# 4. SINGLE API INSTANCE: Performance limited by one container
#
# Performance Characteristics:
#   - Throughput: ~50-100 req/min (depends on content complexity)
#   - Latency: 200ms-2s per request
#   - Cache Hit Rate: 70-90% for repeated URLs
#
# When to Upgrade to Full Deployment:
#   - Need > 100 requests/minute
#   - Require JavaScript rendering
#   - Need background job processing
#   - Multiple API instances for HA
#
# Scaling Options:
#   docker-compose -f docker-compose.simple.yml up -d --scale riptide-api=3
#   (Requires load balancer configuration)
#
# To switch to distributed mode:
#   docker-compose -f docker-compose.simple.yml down
#   docker-compose up -d
# =============================================================================
