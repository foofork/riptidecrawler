# Security and license checking configuration

[licenses]
confidence-threshold = 0.8
allow = [
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "CC0-1.0",
    "Zlib",
    "MPL-2.0",
    "Unicode-3.0",
    "Unicode-DFS-2016",
    "0BSD",
    "NCSA",                     # University of Illinois/NCSA Open Source License (OSI approved, FSF Free/Libre)
    "CDLA-Permissive-2.0",     # Community Data License Agreement Permissive 2.0
]

[bans]
multiple-versions = "warn"
wildcards = "allow"
highlight = "all"

# Allow documented duplicates that are unavoidable due to ecosystem constraints
# Format: { name = "crate-name", version = "=exact.version" }
# Note: Only skip duplicates that cannot be resolved through cargo update
skip = [
    # === MAJOR VERSION CONFLICTS (Breaking Changes) ===
    # bitflags: v1.x (old deps) vs v2.x (modern deps)
    { name = "bitflags" },  # Required by: nix 0.24, inotify 0.9, selectors 0.22

    # hashbrown: Multiple major versions due to indexmap/dashmap ecosystem
    { name = "hashbrown", version = "=0.12.3" },  # indexmap 1.x
    { name = "hashbrown", version = "=0.14.5" },  # dashmap 5.x, wasmparser 0.219
    { name = "hashbrown", version = "=0.15.5" },  # cranelift/regalloc2
    { name = "hashbrown", version = "=0.16.0" },  # indexmap 2.x (latest)

    # indexmap: v1.x (tower) vs v2.x (modern deps)
    { name = "indexmap" },  # tower 0.4 requires indexmap 1.x

    # === HTML PARSING ECOSYSTEM FRAGMENTATION ===
    # Multiple scraper versions require different html5ever/cssparser/selectors

    { name = "cssparser", version = "=0.31.2" },  # scraper 0.20, selectors 0.25
    { name = "cssparser", version = "=0.35.0" },  # lol_html 2.7, selectors 0.32

    { name = "selectors", version = "=0.25.0" },  # scraper 0.20
    { name = "selectors", version = "=0.32.0" },  # lol_html 2.7

    { name = "markup5ever" },  # html5ever 0.27
    { name = "html5ever" },  # scraper 0.20
    { name = "ego-tree" },  # scraper 0.20

    # === WASMTIME DEPENDENCY TREE ===
    # Wasmtime has a large locked dependency tree with specific versions

    { name = "wasmparser", version = "=0.219.2" },  # wit-bindgen 0.34, wasm-metadata 0.219
    { name = "wit-parser", version = "=0.219.2" },  # wit-bindgen-core 0.34

    # === UTILITY CRATES (Semver Conflicts) ===
    # base64: v0.21 (older deps) vs v0.22 (axum/modern deps)
    { name = "base64" },  # ron 0.8, tiktoken-rs

    # getrandom: v0.2 (rand 0.8), v0.3 (tempfile, ahash)
    { name = "getrandom" },  # rand 0.8 (most modern deps)

    { name = "rand_core", version = "=0.6.4" },  # rand 0.8
    { name = "rand_chacha", version = "=0.3.1" },  # rand 0.8

    # dashmap: v5.x (governor) vs v6.x (modern deps)
    { name = "dashmap", version = "=5.5.3" },  # governor 0.6

    # heck: v0.4 (chromiumoxide_pdl) vs v0.5 (clap_derive)
    { name = "heck" },  # chromiumoxide_pdl 0.7

    # console: v0.15 (indicatif 0.17) vs v0.16 (indicatif 0.18)
    { name = "console" },  # indicatif 0.17
    { name = "indicatif" },  # riptide-streaming uses 0.17

    # rustix: v0.38 (crossterm, which) vs v1.x (async-io, modern deps)
    { name = "rustix" },  # crossterm, procfs, which 6.x

    # tower/tower-http: v0.4/v0.5 (axum-prometheus) vs v0.5/v0.6 (axum 0.7)
    { name = "tower", version = "=0.4.13" },  # axum-prometheus 0.7
    { name = "tower-http", version = "=0.5.2" },  # axum-prometheus 0.7

    # phf ecosystem: v0.10/v0.11 (modern)
    { name = "phf_generator" },  # phf_codegen 0.10
    { name = "phf_codegen" },  # selectors 0.25 build

    # derive_more: v0.99 (selectors) vs v2.0 (modern)
    { name = "derive_more", version = "=0.99.20" },  # selectors 0.22/0.25/0.26

    # image/png/gif: Different versions for different use cases
    { name = "png", version = "=0.17.16" },  # image 0.24, plotters
    { name = "image", version = "=0.24.9" },  # plotters 0.3
    { name = "gif", version = "=0.12.0" },  # plotters-bitmap 0.3

    # nix: v0.24 (psutil) vs v0.26 (pprof)
    { name = "nix", version = "=0.24.3" },  # psutil 3.3

    # dirs-sys: v0.4 (directories) vs v0.5 (dirs)
    { name = "dirs-sys", version = "=0.4.1" },  # directories 5.x

    # bit-set/bit-vec: v0.5/v0.6 (fancy-regex) vs v0.8 (proptest)
    { name = "bit-set" },  # fancy-regex 0.12
    { name = "bit-vec" },  # bit-set 0.5

    # === WASMTIME INTERNAL DUPLICATES ===
    { name = "bumpalo" },  # wasm-bindgen vs wasmtime
    { name = "foldhash", version = "=0.1.5" },  # hashbrown 0.15
    { name = "foldhash", version = "=0.2.0" },  # hashbrown 0.16

    # === BUILD-TIME ONLY DUPLICATES ===
    { name = "which", version = "=4.4.2" },  # protobuf-parse (build)

    # === ADDITIONAL UTILITY DUPLICATES ===
    # itertools: Multiple versions across ecosystem
    { name = "itertools" },  # Mid-range dependencies

    # linux-raw-sys: v0.4 (rustix 0.38) vs v0.11 (rustix 1.x)
    { name = "linux-raw-sys" },  # rustix 0.38

    # mio: v0.8 (tokio older) vs v1.0 (tokio newer)
    { name = "mio", version = "=0.8.11" },  # Older tokio versions

    # socket2: v0.5 (older) vs v0.6 (newer)
    { name = "socket2", version = "=0.5.10" },  # Older networking deps

    # smallvec: Same version but different feature sets
    { name = "smallvec" },  # Various feature configurations

    # rustc-hash: v1.x vs v2.x
    { name = "rustc-hash" },  # Older dependencies

    # servo_arc: Multiple versions for HTML parsing ecosystem
    { name = "servo_arc", version = "=0.3.0" },  # selectors 0.25/0.26

    # spin: v0.9 vs v0.10
    { name = "spin", version = "=0.9.8" },  # Older lock-free dependencies

    # thiserror: v1.x vs v2.x
    { name = "thiserror" },  # Most dependencies use v1
    { name = "thiserror-impl" },  # Matches thiserror

    # toml_datetime/toml_edit: v0.6/v0.22 vs v0.7/v0.23
    { name = "toml_datetime" },  # toml 0.8, toml_edit 0.22
    { name = "toml_edit" },  # toml 0.8

    # wasm-encoder: Multiple versions for wasmtime/wit ecosystem
    { name = "wasm-encoder", version = "=0.219.2" },  # wit-component 0.219

    # wast: Different versions for wasmtime ecosystem
    { name = "wast" },  # Older wasmtime testing

    # object: v0.36 (wasmtime 34.x) vs v0.37 (newer)
    { name = "object" },  # Newer backtrace/addr2line
]

# Skip-tree: Ignore duplicate warnings for entire dependency subtrees
# Use this for large dep trees where individual skips become unwieldy
skip-tree = [
    # Wasmtime ecosystem (34.0.2) - large locked dependency tree
    { name = "wasmtime", version = "=34.0.2" },

    # Scraper/HTML parsing - fragmented ecosystem
    { name = "scraper", version = "=0.20.0" },
    { name = "lol_html", version = "=1.2.1" },

    # async-std ecosystem - being phased out but required by chromiumoxide
    { name = "async-std", version = "=1.13.2" },
]

[advisories]
db-path = "~/.cargo/advisory-db"
db-urls = ["https://github.com/rustsec/advisory-db"]
# Updated configuration per cargo-deny 0.16+ migration
# Ignore unmaintained crate advisories for transitive dependencies
# These are informational only and cannot be easily replaced without
# updating or replacing the parent dependencies
ignore = [
    "RUSTSEC-2025-0052",  # async-std unmaintained - pulled by chromiumoxide & httpmock
                          # Replacement strategy: Update chromiumoxide or switch to alternatives
                          # Note: async-std is only used by headless browsing deps
    "RUSTSEC-2024-0436",  # paste unmaintained - pulled by jemalloc-ctl & rav1e
                          # Replacement: pastey (but deeply nested dependency)
                          # Low risk: proc-macro only, no runtime impact
    "RUSTSEC-2025-0057",  # fxhash unmaintained - pulled by wasmtime's fxprof-processed-profile
                          # Replacement: rustc-hash (requires upstream update)
                          # Low risk: only used in wasmtime profiling tools
]
# severity-threshold replaced with severity in cargo-deny 0.16+
# See: https://github.com/EmbarkStudios/cargo-deny/pull/611
# Use advisory severity levels to filter: low, medium, high, critical
# Remove this deprecated key and use advisory-level filtering instead

[sources]
unknown-registry = "warn"
unknown-git = "warn"
allow-registry = ["https://github.com/rust-lang/crates.io-index"]