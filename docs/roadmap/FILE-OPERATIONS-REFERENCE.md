# File Operations Reference - RipTide V1.0

**Purpose:** Quick reference for agents to know which files MOVE, WRAP, or CREATE NEW.

**Last Updated:** 2025-11-04
**Generated by:** Swarm analysis (analyst, researcher, code-analyzer agents)

---

## üö® GOLDEN RULES

1. **WRAP = DO NOT MODIFY** - Only create thin facade wrappers
2. **MOVE = Physical file relocation** - Use `git mv` or copy then refactor
3. **EXTRACT = Copy patterns** - Take best implementation, consolidate, then migrate
4. **CREATE NEW = Write fresh code** - No existing implementation to base on

---

## üìã Complete File Operations Map

### WEEK 0-1: Foundation Consolidation

#### Redis Pooling (Phase 1a-1b)
**Operation:** EXTRACT + MIGRATE

**Sources (10+ files):**
```bash
# Find all current Redis usage
rg "redis::Client::open|ConnectionManager::new" --type rust -l | grep -v target

# Expected sources:
crates/riptide-workers/src/scheduler.rs:193
crates/riptide-workers/src/queue.rs:56
crates/riptide-cache/src/redis.rs (381 lines)
crates/riptide-persistence/src/{cache,state,tenant,sync}.rs
crates/riptide-persistence/tests/integration/mod.rs:92
```

**Destination:** `crates/riptide-utils/src/redis.rs` (NEW FILE)

**Migration Commands:**
```bash
# Phase 1b: Update all 10+ files to use RedisPool
sd "redis::Client::open" "riptide_utils::redis::RedisPool::new" \
  crates/riptide-workers/src/{scheduler,queue}.rs \
  crates/riptide-persistence/src/{cache,state,tenant,sync}.rs \
  crates/riptide-persistence/tests/integration/mod.rs

# Add imports to all updated files
# Add: use riptide_utils::redis::RedisPool;
```

**Verification:**
```bash
# MUST return 0 files after migration
rg "redis::Client::open" --type rust -l | grep -v riptide-utils | grep -v target | wc -l
```

---

#### HTTP Client Factory (Phase 2a-2b)
**Operation:** EXTRACT (if duplication exists)

**Sources (verify first):**
```bash
# Find all reqwest usage
rg "reqwest::Client::builder|Client::new" --type rust -l tests/
# Expected: 19 test files, verify duplication exists
```

**Destination:** `crates/riptide-utils/src/http.rs` (ALREADY EXISTS)

**Status:** ‚ö†Ô∏è Duplication not confirmed. Verify before migrating.

---

#### Retry Logic (Phase 3a-3b)
**Operation:** EXTRACT + MIGRATE (high-priority subset)

**Canonical Source:**
```bash
# Use riptide-fetch as canonical implementation
cat crates/riptide-fetch/src/fetch.rs | grep -A 20 "retry"
```

**High-Priority Targets (7 files):**
```
crates/riptide-intelligence/src/smart_retry.rs
crates/riptide-intelligence/src/circuit_breaker.rs
crates/riptide-intelligence/src/fallback.rs
crates/riptide-intelligence/src/background_processor.rs
crates/riptide-intelligence/src/llm_client_pool.rs
crates/riptide-workers/src/job.rs
crates/riptide-intelligence/tests/smart_retry_tests.rs
```

**Destination:** `crates/riptide-utils/src/retry.rs` (ALREADY EXISTS)

**Remaining:** 29/36 files deferred to Week 1-2

---

### WEEK 2.5-3: Spider Decoupling

#### Extract Spider Content Extraction
**Operation:** MOVE (physical file relocation)

**Source:**
```
File: crates/riptide-spider/src/core.rs
Lines: 620-647
Functions to move:
  - extract_text_content() (lines 620-626)
  - simple_text_extraction() (lines 628-647)
  - extract_links_basic() (referenced at line 613)
```

**Move Commands:**
```bash
# Step 1: Extract functions to new file
cat > crates/riptide-spider/src/extractor.rs << 'EOF'
// Extracted from core.rs:620-647

pub trait ContentExtractor {
    fn extract(&self, html: &str) -> ExtractionResult;
}

pub struct BasicExtractor;

impl ContentExtractor for BasicExtractor {
    fn extract(&self, html: &str) -> ExtractionResult {
        // [MOVE extract_text_content() here - lines 620-626]
        // [MOVE simple_text_extraction() here - lines 628-647]
        // [MOVE extract_links_basic() here - line 613]
    }
}
EOF

# Step 2: Replace in core.rs with trait calls
sd "extract_text_content\(html\)" "self.extractor.extract(html)" \
  crates/riptide-spider/src/core.rs

# Step 3: Verify move complete
rg "extract_text_content|simple_text_extraction" crates/riptide-spider/src/core.rs
# Should return 0 results
```

**Verification:**
```bash
# Old functions should be gone from core.rs
rg "fn extract_text_content|fn simple_text_extraction" crates/riptide-spider/src/core.rs | wc -l
# Expected: 0

# New trait should exist
rg "trait ContentExtractor" crates/riptide-spider/src/extractor.rs | wc -l
# Expected: 1
```

---

### WEEK 9: Facade Unification (CRITICAL - WRAP NOT REWRITE)

#### Wrap PipelineOrchestrator
**Operation:** WRAP (DO NOT MODIFY EXISTING CODE)

**Sources (DO NOT TOUCH):**
```
crates/riptide-api/src/pipeline.rs (1,071 lines) ‚ùå DO NOT MODIFY
crates/riptide-api/src/strategies_pipeline.rs (525 lines) ‚ùå DO NOT MODIFY
TOTAL: 1,596 lines of production code
```

**Wrapper Creation:**
```bash
# Create NEW wrapper file (do not modify originals)
cat > crates/riptide-facade/src/facades/crawl_facade.rs << 'EOF'
use crate::riptide_api::pipeline::PipelineOrchestrator;
use crate::riptide_api::strategies_pipeline::StrategiesPipelineOrchestrator;
use std::sync::Arc;

/// Thin facade wrapper over existing orchestrators
/// ‚ùå DO NOT REBUILD - delegates to existing production code
pub struct CrawlFacade {
    pipeline: Arc<PipelineOrchestrator>,
    strategies: Arc<StrategiesPipelineOrchestrator>,
}

impl CrawlFacade {
    pub fn new(pipeline: Arc<PipelineOrchestrator>, strategies: Arc<StrategiesPipelineOrchestrator>) -> Self {
        Self { pipeline, strategies }
    }

    /// Delegates to existing pipeline (DO NOT REIMPLEMENT)
    pub async fn crawl(&self, url: &str) -> Result<CrawlResult> {
        // WRAP: Delegate to existing orchestrator
        self.pipeline.execute(url).await
    }

    /// Delegates to existing strategies pipeline
    pub async fn crawl_with_strategy(&self, url: &str, strategy: Strategy) -> Result<CrawlResult> {
        // WRAP: Delegate to existing orchestrator
        self.strategies.execute_with_strategy(url, strategy).await
    }
}
EOF
```

**Verification:**
```bash
# Verify originals unchanged
git diff crates/riptide-api/src/pipeline.rs | wc -l
# Expected: 0 (no changes)

git diff crates/riptide-api/src/strategies_pipeline.rs | wc -l
# Expected: 0 (no changes)

# Verify wrapper exists
test -f crates/riptide-facade/src/facades/crawl_facade.rs && echo "‚úÖ Wrapper created"
```

---

## üéØ Quick Decision Matrix

| Scenario | Action | Files Affected | Command Type |
|----------|--------|----------------|--------------|
| **Duplicate code 3+ places** | EXTRACT | Multiple ‚Üí 1 | `sd` (find/replace) |
| **Working code >1,500 lines** | WRAP | 0 (create wrapper only) | `cat > wrapper.rs` |
| **Embedded code in wrong place** | MOVE | 1 ‚Üí 1 | `git mv` or extract+delete |
| **New functionality needed** | CREATE NEW | 0 ‚Üí 1 | `cargo new` or `cat >` |
| **Config needs consolidation** | REFACTOR | 1 (rename in place) | `sd` with struct rename |

---

## üö´ What NOT to Do

### ‚ùå NEVER Rebuild These Files:
1. `crates/riptide-api/src/pipeline.rs` (1,071 lines)
2. `crates/riptide-api/src/strategies_pipeline.rs` (525 lines)

### ‚ùå NEVER Skip Migration Phase:
- Week 0-1: Phase 1b (Redis), Phase 2b (HTTP), Phase 3b (Retry) are MANDATORY
- Verify with `rg` commands that old patterns are gone

### ‚ùå NEVER Create When You Should Extract:
- Redis: EXTRACT from 10+ files, don't write new
- Retry: EXTRACT from riptide-fetch, don't write new
- HTTP: EXTRACT from tests (if duplication exists), don't write new

---

## ‚úÖ Verification Checklist

Before claiming a task is complete:

**For EXTRACT operations:**
- [ ] Source files identified with `rg` commands
- [ ] Consolidated implementation created
- [ ] All source files migrated to use consolidated version
- [ ] Old patterns removed (verify with `rg | wc -l` = 0)
- [ ] Tests pass

**For MOVE operations:**
- [ ] Source file/lines identified
- [ ] Code physically relocated (not rewritten)
- [ ] Source location cleaned up
- [ ] Imports updated
- [ ] Tests pass

**For WRAP operations:**
- [ ] Original files UNCHANGED (`git diff` = 0 lines)
- [ ] Thin wrapper created
- [ ] Wrapper delegates to original
- [ ] No logic duplication
- [ ] Tests pass

---

## üìù File Count Accuracy (Verified 2025-11-04)

| Item | Roadmap Claim | Actual Count | Status |
|------|---------------|--------------|--------|
| Pipeline lines | 1,596 | 1,596 | ‚úÖ 100% accurate |
| Redis files | 3 | 10+ | ‚ö†Ô∏è Understated |
| HTTP test files | 8+ | 19 | ‚ö†Ô∏è Duplication unverified |
| Retry files | 125+ | 36 | ‚ùå 347% overcount |
| High-priority retry | 10 | 7 | ‚ö†Ô∏è Overestimated |

---

## üîó Cross-References

- **Main Roadmap:** `/workspaces/eventmesh/docs/roadmap/RIPTIDE-V1-DEFINITIVE-ROADMAP.md`
- **Swarm Analysis:** Generated 2025-11-04 by analyst, researcher, code-analyzer agents
- **Verification Report:** All files verified to exist with correct line counts
