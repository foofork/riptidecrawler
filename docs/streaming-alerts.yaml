# RipTide Streaming Alert Rules
# These rules can be imported into Prometheus/Alertmanager

groups:
  - name: streaming_alerts
    interval: 30s
    rules:
      # Critical Alerts
      - alert: StreamingErrorRateCritical
        expr: riptide_streaming_error_rate > 0.10
        for: 5m
        labels:
          severity: critical
          component: streaming
        annotations:
          summary: "Critical streaming error rate"
          description: "Streaming error rate is {{ $value | humanizePercentage }}, exceeding 10% threshold"

      - alert: StreamingMemoryCritical
        expr: riptide_streaming_memory_usage_bytes > 1000000000
        for: 5m
        labels:
          severity: critical
          component: streaming
        annotations:
          summary: "Critical streaming memory usage"
          description: "Streaming memory usage is {{ $value | humanize1024 }}, exceeding 1GB"

      - alert: MessageDropRateCritical
        expr: (rate(riptide_streaming_messages_dropped_total[5m]) / (rate(riptide_streaming_messages_sent_total[5m]) + rate(riptide_streaming_messages_dropped_total[5m]))) > 0.20
        for: 5m
        labels:
          severity: critical
          component: streaming
        annotations:
          summary: "Critical message drop rate"
          description: "Message drop rate is {{ $value | humanizePercentage }}, exceeding 20%"

      # Warning Alerts
      - alert: StreamingErrorRateWarning
        expr: riptide_streaming_error_rate > 0.05 and riptide_streaming_error_rate <= 0.10
        for: 10m
        labels:
          severity: warning
          component: streaming
        annotations:
          summary: "Elevated streaming error rate"
          description: "Streaming error rate is {{ $value | humanizePercentage }}, exceeding 5% threshold"

      - alert: StreamingMemoryWarning
        expr: riptide_streaming_memory_usage_bytes > 500000000 and riptide_streaming_memory_usage_bytes <= 1000000000
        for: 10m
        labels:
          severity: warning
          component: streaming
        annotations:
          summary: "High streaming memory usage"
          description: "Streaming memory usage is {{ $value | humanize1024 }}, exceeding 500MB"

      - alert: MessageDropRateWarning
        expr: (rate(riptide_streaming_messages_dropped_total[5m]) / (rate(riptide_streaming_messages_sent_total[5m]) + rate(riptide_streaming_messages_dropped_total[5m]))) > 0.10 and (rate(riptide_streaming_messages_dropped_total[5m]) / (rate(riptide_streaming_messages_sent_total[5m]) + rate(riptide_streaming_messages_dropped_total[5m]))) <= 0.20
        for: 10m
        labels:
          severity: warning
          component: streaming
        annotations:
          summary: "Elevated message drop rate"
          description: "Message drop rate is {{ $value | humanizePercentage }}, exceeding 10%"

      - alert: ConnectionDurationP99High
        expr: histogram_quantile(0.99, rate(riptide_streaming_connection_duration_seconds_bucket[5m])) > 60
        for: 10m
        labels:
          severity: warning
          component: streaming
        annotations:
          summary: "High P99 connection duration"
          description: "P99 connection duration is {{ $value }}s, exceeding 60s threshold"

      # Info Alerts
      - alert: HighActiveConnections
        expr: riptide_streaming_active_connections > 100
        for: 15m
        labels:
          severity: info
          component: streaming
        annotations:
          summary: "High number of active connections"
          description: "{{ $value }} active streaming connections"

      - alert: BackpressureDetected
        expr: rate(riptide_streaming_messages_dropped_total[5m]) * 60 > 5
        for: 5m
        labels:
          severity: info
          component: streaming
        annotations:
          summary: "Backpressure detected"
          description: "{{ $value }} messages dropped per minute due to backpressure"

      - alert: LowThroughput
        expr: rate(riptide_streaming_messages_sent_total[5m]) < 1
        for: 15m
        labels:
          severity: info
          component: streaming
        annotations:
          summary: "Low streaming throughput"
          description: "Streaming throughput is {{ $value }} messages/sec"
