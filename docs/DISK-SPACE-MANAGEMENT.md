# Disk Space Management Guide

## Overview

This project includes comprehensive disk space management tools to handle the large build artifacts generated by Rust compilation and other build processes. The EventMesh workspace can grow to 40GB+ with full build artifacts, making proactive disk management essential.

## Problem Statement

### Current Disk Usage Analysis

- **Workspace Size:** 44GB used out of 63GB (74% utilization)
- **Critical Directories:**
  - `target/debug/`: 14GB (Rust build artifacts)
    - `target/debug/deps/`: 9.5GB (compiled dependencies)
    - `target/debug/incremental/`: 4GB (incremental compilation cache)
    - `target/debug/build/`: 876MB (build scripts)
  - `node_modules/`: ~300MB total
    - `cli/node_modules/`: 89MB
    - `playground/node_modules/`: 202MB
  - `test-results/`, `coverage/`, `eval/results/`: ~12MB

### What Can Be Safely Cleaned

**Always Safe to Remove:**
- `target/debug/incremental/` - Incremental compilation cache (rebuilds quickly)
- `target/debug/deps/` - Compiled dependencies (rebuilt from Cargo.lock)
- `target/debug/.fingerprint/` - Build fingerprints
- `*.d`, `*.rlib`, `*.rmeta` files - Rust intermediate artifacts
- Old log files (>7 days)
- Old test results (>7 days)

**Safe with Reinstall:**
- `node_modules/` - Can reinstall from package-lock.json
- `playground/dist/` - Frontend build output
- `cli/dist/` - CLI build output

**Keep Unless Critical:**
- `target/debug/` executables - Saves rebuild time
- `.cargo/registry/` - Downloaded crates (speeds up builds)
- Recent test results and logs

## Available Scripts

### 1. cleanup-disk.sh

**Purpose:** Comprehensive cleanup with safety levels

**Usage:**
```bash
# Preview what would be cleaned (recommended first run)
./scripts/cleanup-disk.sh --dry-run

# Standard cleanup (removes incremental cache, old logs)
./scripts/cleanup-disk.sh

# Aggressive cleanup (removes entire target directory)
./scripts/cleanup-disk.sh --aggressive

# Preview aggressive cleanup
./scripts/cleanup-disk.sh --dry-run --aggressive
```

**What It Cleans:**

*Standard Mode:*
- ✅ Rust incremental compilation cache (~4GB)
- ✅ Rust debug dependencies (~9.5GB)
- ✅ Rust intermediate files (.d, .rlib, .rmeta)
- ✅ Old log files (>7 days)
- ✅ Test node_modules
- ✅ Build output directories (dist/)

*Aggressive Mode (adds):*
- ✅ Entire target/debug/ directory
- ✅ All node_modules/ directories
- ✅ All test results and coverage
- ✅ npm cache

**Expected Space Savings:**
- Standard: ~13-14GB
- Aggressive: ~14.5GB

### 2. pre-build-check.sh

**Purpose:** Automated pre-build disk space validation

**Usage:**
```bash
# Check disk space before building
./scripts/pre-build-check.sh
```

**Features:**
- Checks if at least 10GB free space is available
- Auto-runs cleanup if space is insufficient
- Shows target directory size and warnings
- Exits with error code if cleanup fails

**Integration:**
```bash
# Add to your build workflow
./scripts/pre-build-check.sh && cargo build
```

### 3. smart-cleanup.sh

**Purpose:** Intelligent cleanup based on available space

**Usage:**
```bash
# Let the script decide cleanup level
./scripts/smart-cleanup.sh

# Preview smart cleanup
./scripts/smart-cleanup.sh --dry-run
```

**Cleanup Strategies:**

| Available Space | Strategy | Actions |
|----------------|----------|---------|
| < 5GB | Critical | Aggressive cleanup + manual intervention prompts |
| 5-10GB | Aggressive | Full cleanup with all safety measures |
| 10-20GB | Moderate | Standard cleanup |
| > 20GB | Light | Only incremental cache and old logs |

### 4. disk-monitor.sh

**Purpose:** Continuous disk space monitoring

**Usage:**
```bash
# Quick status check
./scripts/disk-monitor.sh

# Full report
./scripts/disk-monitor.sh --report
```

**Exit Codes:**
- `0` - Healthy (< 75% usage)
- `1` - Warning (75-85% usage)
- `2` - Critical (> 85% usage)

**Features:**
- Generates comprehensive disk usage reports
- Shows top 10 largest directories
- Breaks down build artifacts by type
- Provides actionable recommendations

## Automation

### GitHub Actions Workflow

The project includes automated disk cleanup via GitHub Actions:

**File:** `.github/workflows/disk-cleanup.yml`

**Triggers:**
1. **Scheduled:** Daily at 2 AM UTC
2. **Manual:** Via workflow_dispatch with options:
   - Cleanup type: standard/aggressive/smart
   - Dry run: preview changes

**What It Does:**
- Monitors disk usage
- Runs appropriate cleanup
- Generates cleanup reports
- Uploads artifacts for review

**Manual Trigger:**
```bash
# Via GitHub CLI
gh workflow run disk-cleanup.yml -f cleanup_type=aggressive -f dry_run=false
```

### Pre-commit Hook (Optional)

Add to `.git/hooks/pre-commit`:
```bash
#!/bin/bash
# Check disk space before commit
./scripts/disk-monitor.sh
exit 0  # Don't block commits, just warn
```

### Cron Job Setup

For local development:
```bash
# Add to crontab (runs daily at 2 AM)
0 2 * * * cd /workspaces/eventmesh && ./scripts/smart-cleanup.sh
```

## NPM Scripts Integration

Add to `package.json`:
```json
{
  "scripts": {
    "clean": "./scripts/cleanup-disk.sh",
    "clean:aggressive": "./scripts/cleanup-disk.sh --aggressive",
    "clean:preview": "./scripts/cleanup-disk.sh --dry-run",
    "prebuild": "./scripts/pre-build-check.sh",
    "disk:check": "./scripts/disk-monitor.sh",
    "disk:report": "./scripts/disk-monitor.sh --report",
    "disk:smart": "./scripts/smart-cleanup.sh"
  }
}
```

Usage:
```bash
npm run clean              # Standard cleanup
npm run clean:aggressive   # Aggressive cleanup
npm run clean:preview      # Preview cleanup
npm run disk:check         # Check disk status
npm run disk:smart         # Smart cleanup
```

## Best Practices

### Daily Development

1. **Before Starting Work:**
   ```bash
   ./scripts/disk-monitor.sh
   ```

2. **Before Major Builds:**
   ```bash
   ./scripts/pre-build-check.sh
   cargo build --release
   ```

3. **When Switching Branches:**
   ```bash
   cargo clean
   # or
   ./scripts/cleanup-disk.sh
   ```

4. **End of Day:**
   ```bash
   ./scripts/smart-cleanup.sh
   ```

### CI/CD Integration

1. **Add pre-build check to CI:**
   ```yaml
   - name: Check disk space
     run: ./scripts/pre-build-check.sh
   ```

2. **Cache cleanup in CI:**
   ```yaml
   - name: Cleanup before cache
     run: ./scripts/cleanup-disk.sh --aggressive
   ```

3. **Post-build cleanup:**
   ```yaml
   - name: Cleanup artifacts
     if: always()
     run: ./scripts/cleanup-disk.sh
   ```

### Emergency Procedures

**When Disk is Full (>90%):**

1. **Immediate cleanup:**
   ```bash
   ./scripts/cleanup-disk.sh --aggressive
   ```

2. **Manual intervention:**
   ```bash
   # Remove entire target directory
   rm -rf target/

   # Clean cargo cache
   cargo clean

   # Clean npm cache
   npm cache clean --force

   # Remove node_modules
   find . -name "node_modules" -type d -prune -exec rm -rf {} \;
   ```

3. **Docker cleanup (if applicable):**
   ```bash
   docker system prune -a --volumes
   ```

4. **Find large files:**
   ```bash
   du -h . | sort -rh | head -20
   ```

## Disk Space Allocation Guidelines

### Recommended Disk Space

- **Minimum:** 20GB free for development
- **Comfortable:** 30GB free
- **Ideal:** 40GB+ free

### Space Budgeting

| Directory | Typical Size | Max Size | Cleanup Frequency |
|-----------|--------------|----------|-------------------|
| `target/debug/` | 5-14GB | 20GB | Weekly |
| `target/release/` | 2-5GB | 10GB | After releases |
| `node_modules/` | 200-500MB | 1GB | Monthly |
| Test results | 10-50MB | 100MB | Weekly |
| Logs | 5-20MB | 50MB | Weekly |

### Warning Thresholds

- **Green:** < 70% disk usage - No action needed
- **Yellow:** 70-85% usage - Schedule cleanup
- **Red:** > 85% usage - Immediate cleanup required
- **Critical:** > 95% usage - Emergency procedures

## Troubleshooting

### Script Fails to Run

**Issue:** Permission denied
```bash
chmod +x scripts/*.sh
```

**Issue:** Command not found
```bash
# Ensure running from workspace root
cd /workspaces/eventmesh
./scripts/cleanup-disk.sh
```

### Cleanup Doesn't Free Space

**Possible causes:**
1. Files in use by running processes
2. Deleted files held by open file handles
3. Hidden files not covered by cleanup

**Solutions:**
```bash
# Stop running processes
pkill -f cargo
pkill -f node

# List open deleted files
lsof | grep deleted

# Force filesystem sync
sync
```

### Disk Still Full After Aggressive Cleanup

**Additional steps:**
```bash
# Check for large files
find . -type f -size +100M -exec ls -lh {} \;

# Check system logs
sudo journalctl --disk-usage

# Check Docker
docker system df
```

## Monitoring and Alerts

### Set Up Alerts

**Email notifications (Linux):**
```bash
# Add to crontab
0 */6 * * * /workspaces/eventmesh/scripts/disk-monitor.sh | mail -s "Disk Space Alert" you@example.com
```

**Slack notifications:**
```bash
# Modify disk-monitor.sh to send Slack webhook
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"Disk usage critical!"}' \
  $SLACK_WEBHOOK_URL
```

### Metrics Collection

Track cleanup effectiveness:
```bash
# Log cleanup runs
echo "$(date): $(df -h . | tail -1)" >> .cleanup-history.log
```

## Summary

### Quick Reference

| Task | Command |
|------|---------|
| Check disk space | `./scripts/disk-monitor.sh` |
| Quick cleanup | `./scripts/cleanup-disk.sh` |
| Smart cleanup | `./scripts/smart-cleanup.sh` |
| Preview cleanup | `./scripts/cleanup-disk.sh --dry-run` |
| Pre-build check | `./scripts/pre-build-check.sh` |
| Emergency cleanup | `./scripts/cleanup-disk.sh --aggressive` |

### Expected Results

- **Current state:** 44GB used, 16GB free (74% usage)
- **After standard cleanup:** ~30GB used, 30GB free (50% usage)
- **After aggressive cleanup:** ~29GB used, 31GB free (48% usage)
- **Target state:** < 35GB used, > 25GB free (< 60% usage)

---

**Last Updated:** 2025-11-02
**Maintained By:** Disk Space Management Specialist
