{
  "phase": "Phase 5 - Engine Selection Consolidation",
  "task": "Research duplicate engine selection logic",
  "status": "COMPLETE",
  "completion_date": "2025-10-23",

  "duplicate_locations": [
    {
      "file": "crates/riptide-cli/src/commands/engine_fallback.rs",
      "lines": "79-169",
      "size_lines": 91,
      "function": "analyze_content_for_engine()",
      "details": "Full content analysis with React/Vue/Angular detection, SPA markers, content ratio calculation, anti-scraping detection",
      "status": "TO_BE_REMOVED"
    },
    {
      "file": "crates/riptide-cli/src/commands/extract.rs",
      "lines": "48-108",
      "size_lines": 61,
      "function": "Engine::gate_decision() + calculate_content_ratio()",
      "details": "Simplified engine selection with framework detection",
      "status": "BEING_CONSOLIDATED"
    },
    {
      "file": "crates/riptide-api/src/pipeline.rs",
      "lines": "652-724",
      "size_lines": 73,
      "function": "PipelineOrchestrator::analyze_content()",
      "details": "SPA marker detection (4 markers), domain priors, GateFeatures extraction",
      "status": "TO_BE_REMOVED"
    },
    {
      "file": "crates/riptide-api/src/strategies_pipeline.rs",
      "lines": "348-413",
      "size_lines": 66,
      "function": "StrategiesPipelineOrchestrator::analyze_content()",
      "details": "Nearly identical to pipeline.rs - 95% code overlap",
      "status": "TO_BE_REMOVED"
    },
    {
      "file": "crates/riptide-api/src/handlers/render/strategies.rs",
      "lines": "8-94",
      "size_lines": 87,
      "function": "analyze_url_for_dynamic_content()",
      "details": "URL-based framework detection for 20+ popular sites (Twitter, GitHub, Reddit, Medium, etc.)",
      "status": "KEEP_SEPARATE"
    },
    {
      "file": "tests/integration/engine_selection_tests.rs",
      "lines": "399-487",
      "size_lines": 89,
      "function": "calculate_content_ratio() + analyze_content_comprehensive()",
      "details": "Test-only duplicate for validation - should use actual implementation",
      "status": "TO_BE_UPDATED"
    }
  ],

  "summary": {
    "total_duplicate_lines": 393,
    "files_affected": 6,
    "core_logic_to_consolidate": 240,
    "test_duplicates": 89,
    "url_analysis_logic": 87
  },

  "common_detection_patterns": {
    "frameworks": [
      "React: __NEXT_DATA__, react, _reactRoot, __webpack_require__",
      "Vue: v-app, vue, createApp",
      "Angular: ng-app, ng-version, platformBrowserDynamic"
    ],
    "spa_markers": [
      "__webpack",
      "window.__INITIAL_STATE__",
      "data-reactroot / data-react-helmet",
      "Large root divs (id='root' with 20+ divs)"
    ],
    "calculations": [
      "content_ratio = visible_text / html_length",
      "script_density = script_bytes / html_bytes",
      "text_ratio for quality scoring"
    ],
    "metadata": [
      "Open Graph: property='og:'",
      "JSON-LD: @type=Article",
      "Semantic HTML: <article>, <main>, <p>, <h1>, <h2>"
    ],
    "anti_scraping": [
      "Cloudflare verification",
      "reCAPTCHA / hCaptcha",
      "PerimeterX detection"
    ]
  },

  "dependency_analysis": {
    "current_state": {
      "riptide_cli": ["riptide-extraction", "riptide-browser", "riptide-reliability (NEW)"],
      "riptide_api": ["riptide-fetch", "riptide-reliability::gate", "riptide-types"],
      "riptide_reliability": ["riptide-types", "riptide-fetch", "tokio", "serde"]
    },
    "consolidation_target": "riptide-reliability crate",
    "existing_structure": {
      "gate.rs": "GateFeatures, Decision enum, score(), decide(), should_use_headless()",
      "new_module": "engine_selection.rs (BEING CREATED)"
    },
    "no_circular_dependencies": true,
    "clean_dependency_flow": "CLI/API → riptide-reliability → riptide-types"
  },

  "consolidation_options_compared": {
    "option1_riptide_reliability": {
      "score": 9.5,
      "pros": [
        "✅ Crate already exists",
        "✅ Has gate module with GateFeatures",
        "✅ API already uses it",
        "✅ Perfect conceptual fit (reliability patterns)",
        "✅ No new dependencies needed",
        "✅ Clean CLI → reliability dependency"
      ],
      "cons": [
        "⚠️  Need to add HTML parsing helpers"
      ],
      "required_additions": [
        "Add engine_selection.rs module",
        "Move framework detection logic",
        "Move content analysis functions",
        "Keep gate.rs for scoring/decision logic"
      ]
    },
    "option3_tiny_internal_crate": {
      "score": 5.0,
      "pros": [
        "Clean separation",
        "Zero external dependencies possible"
      ],
      "cons": [
        "❌ Creates unnecessary crate",
        "❌ Duplicates gate.rs concepts",
        "❌ API would need both crates",
        "❌ More complex dependency graph"
      ]
    }
  },

  "recommendation": {
    "choice": "Option 1 - Consolidate into riptide-reliability",
    "confidence": "HIGH",
    "rationale": [
      "1. riptide-reliability already exists and is the right fit",
      "2. API already imports riptide-reliability::gate::decide()",
      "3. Gate/reliability patterns are conceptually correct home",
      "4. Adding engine_selection module extends naturally",
      "5. Avoids creating new crate",
      "6. Zero risk of circular dependencies",
      "7. CLI gains circuit breaker access as bonus"
    ],
    "implementation_structure": {
      "riptide_reliability_gate_rs": "Keep existing GateFeatures, score(), decide()",
      "riptide_reliability_engine_selection_rs": "NEW - framework detection, content analysis, Engine enum",
      "benefits": "Separation of concerns: gate.rs = scoring logic, engine_selection.rs = HTML analysis"
    }
  },

  "risk_assessment": {
    "level": "LOW",
    "breaking_changes": "None - pure addition to riptide-reliability",
    "dependency_cycles": "None detected",
    "complexity": "Low - ~120 lines core logic to move",
    "testing_impact": "Tests can be migrated easily",
    "backwards_compatibility": "100% - additive only"
  },

  "implementation_roadmap": {
    "phase1_create_module": {
      "status": "IN_PROGRESS",
      "tasks": [
        "Create riptide-reliability/src/engine_selection.rs",
        "Define Engine enum (Raw, Wasm, Headless, Auto)",
        "Add framework detection functions",
        "Add ContentAnalysis struct",
        "Add analyze_content() and calculate_content_ratio()"
      ]
    },
    "phase2_update_cli": {
      "status": "IN_PROGRESS",
      "tasks": [
        "Import Engine from riptide-reliability::engine_selection",
        "Remove duplicate logic from extract.rs",
        "Remove engine_fallback.rs or repurpose as thin wrapper",
        "Update tests to use shared implementation"
      ]
    },
    "phase3_update_api": {
      "status": "PENDING",
      "tasks": [
        "Import analyze_content from riptide-reliability",
        "Remove duplicate from pipeline.rs",
        "Remove duplicate from strategies_pipeline.rs",
        "Keep render/strategies.rs separate (URL-specific logic)"
      ]
    },
    "phase4_cleanup": {
      "status": "PENDING",
      "tasks": [
        "Remove test duplicates",
        "Update documentation",
        "Run full test suite",
        "Verify no regressions"
      ]
    }
  },

  "metrics": {
    "code_reduction": {
      "duplicate_lines_removed": 240,
      "test_lines_updated": 89,
      "net_reduction": "~200 lines",
      "maintainability_improvement": "Single source of truth"
    },
    "files_modified": {
      "new": 1,
      "modified": 5,
      "deleted_or_gutted": 2
    }
  },

  "next_steps": [
    "1. Complete engine_selection.rs module in riptide-reliability",
    "2. Update CLI imports and remove duplicates",
    "3. Update API pipelines to use consolidated logic",
    "4. Migrate tests to use real implementation",
    "5. Document consolidated architecture",
    "6. Performance validation (expect neutral to slight improvement)"
  ],

  "notes": [
    "render/strategies.rs should remain separate - it's URL analysis, not HTML content analysis",
    "Gate module already has 70% of the conceptual framework",
    "This consolidation is a prerequisite for Phase 6 (browser pool improvements)",
    "Consider extracting domain priors to config file in future"
  ]
}
