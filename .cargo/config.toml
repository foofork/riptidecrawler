# Cargo configuration for WASM Component Model builds
# Enhanced configuration for RipTide WASM components

[build]
# Default target for development builds
target-dir = "target"
jobs = 16  # Increase parallel jobs for faster builds
incremental = true
# rustc-wrapper = "sccache"  # Use sccache for compilation caching - Disabled (not available)

[target.x86_64-unknown-linux-gnu]
rustflags = [
    "-C", "split-debuginfo=packed",
    "-C", "target-cpu=native"
]

[target.wasm32-wasip2]
# Use wasmtime as the runner for testing WASM components
runner = "wasmtime run --wasm component-model --allow-unknown-exports"

# Optimized linker configuration for WASM builds
linker = "rust-lld"
rustflags = [
    "-C", "target-feature=+simd128",
    "-C", "opt-level=s",
    "-C", "lto=thin",
    "-C", "codegen-units=1",
    "-C", "panic=abort",
    "-C", "strip=symbols",
    "-C", "link-arg=-O2",
    # Additional WASM-specific optimizations
    "-C", "link-arg=--gc-sections",
    "-C", "link-arg=--strip-all",
]

# wasm32-wasip1 removed - standardized on wasm32-wasip2

[env]
# Optimize for size and enable SIMD for WASM targets
RUSTFLAGS = "-C target-feature=+simd128 -C opt-level=s -C codegen-units=1"

# Component model specific flags
WASM_COMPONENT_MODEL = "1"

# Enable trek-rs features for content extraction
TREK_FEATURES = "full"

[net]
# Use sparse registry for faster dependency resolution
git-fetch-with-cli = true
retry = 3

[registries.crates-io]
protocol = "sparse"

[profile.dev]
opt-level = 0
debug = 0
split-debuginfo = "packed"
incremental = true
overflow-checks = false

[profile.test]
opt-level = 0
debug = 0
incremental = true

[profile.bench]
opt-level = 3
lto = "thin"

[profile.release-wasm]
# Optimized profile specifically for WASM builds
inherits = "release"
opt-level = "s"          # Optimize for size
lto = true              # Enable link-time optimization
codegen-units = 1       # Single codegen unit for better optimization
panic = "abort"         # Reduce binary size by aborting on panic
strip = true           # Strip debug symbols

[profile.dev-wasm]
# Development profile for faster WASM builds
inherits = "dev"
opt-level = 1          # Some optimization for better performance
debug = 1             # Reduced debug info for smaller binaries

# Test parallelization settings for improved test performance
[test]
parallel = true
jobs = 16              # Increased for faster parallel testing
timeout = 600          # 10 minute timeout for long-running tests

# WASM-specific build cache and optimization settings
# Using wasm32-wasip2 exclusively for all WASM builds

# Improved build cache configuration (merged with earlier [build] section)

# Cache configuration for sccache (moved to earlier [env] section to avoid duplicates)