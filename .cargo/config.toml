[build]
# Use default target for the platform
target = "x86_64-unknown-linux-gnu"

# Shared target directory for all workspace crates
target-dir = "target"

# sccache configuration for faster incremental builds
# Install: cargo install sccache
# Verify: sccache --show-stats
rustc-wrapper = "sccache"

# Note: Removed forced linker selection to allow cargo and dependencies
# (like pdfium-render) to choose appropriate linker based on availability

# Native x86_64 builds - Use baseline CPU for portability (avoids SIGILL errors)
# Changed from target-cpu=native to x86-64-v2 for wider compatibility
[target.'cfg(all(target_arch = "x86_64", not(target_family = "wasm")))']
rustflags = [
  "-C", "target-cpu=x86-64-v2",  # Baseline: 2009+ CPUs (SSE4.2, POPCNT)
]

# WASM builds - must NOT inherit x86 CPU flags
[target.wasm32-wasi]
rustflags = []

[target.wasm32-wasip2]
rustflags = [
  "-C", "link-arg=--initial-memory=268435456",  # 256MB initial (4096 pages × 64KB)
  "-C", "link-arg=--max-memory=536870912",      # 512MB max (8192 pages × 64KB)
  "-C", "link-arg=-zstack-size=2097152",         # 2MB stack size
]

# Coverage configuration for cargo-llvm-cov
# Unified coverage across all 24 workspace crates
[alias]
coverage = "llvm-cov"
coverage-html = "llvm-cov --html"
coverage-json = "llvm-cov --json"
coverage-lcov = "llvm-cov --lcov"
coverage-all = "llvm-cov --all-features --workspace --lcov --output-path lcov.info"

# sccache environment configuration
[env]
SCCACHE_DIR = { value = ".sccache", relative = true }
SCCACHE_CACHE_SIZE = "10G"
SCCACHE_IDLE_TIMEOUT = "0"
