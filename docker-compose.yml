# ============================================================================
# RipTide - Default Docker Compose Configuration
# ============================================================================
# FULL-FEATURED deployment with COMPLETE functionality:
#   ✅ RipTide API (REST API + WebSocket)
#   ✅ Chrome Browser Service (5 browser pool for JavaScript rendering)
#   ✅ Redis (caching and session storage)
#   ✅ Swagger UI (API documentation)
#   ✅ Health monitoring
#
# This is the RECOMMENDED configuration for 95% of users!
#
# Quick Start:
#   cp .env.example .env           # Configure environment
#   # Edit .env: Add SERPER_API_KEY
#   docker-compose up -d            # Start all services
#   docker-compose logs -f          # View logs
#   docker-compose down             # Stop services
#
# What You Get:
#   - Full Chrome rendering with 5-browser pool
#   - JavaScript execution for SPA pages
#   - WASM extraction as fallback
#   - Memory: ~1.2GB total
#
# ============================================================================
# CONFIGURATION OPTIONS
# ============================================================================
#
# Option 1: DEFAULT (Included Chrome - Recommended)
#   HEADLESS_URL=http://riptide-headless:9123
#   Keep riptide-headless service uncommented (lines 161-193)
#   Result: Full Chrome rendering with 5 browsers ✅
#
# Option 2: EXTERNAL BROWSER FARM (Advanced)
#   HEADLESS_URL=https://your-browser-farm.example.com:9123
#   Comment out riptide-headless service (lines 161-193)
#   Result: API uses your external Chrome infrastructure
#
# Option 3: LIGHTWEIGHT (WASM-only)
#   Use: docker-compose -f docker-compose.lite.yml up -d
#   Result: WASM extraction only, no Chrome (~440MB)
#
# ============================================================================

version: '3.8'

services:
  # =========================================================================
  # RipTide API - Core web scraping and extraction service
  # Native-parser only (optimized for production)
  # =========================================================================
  riptide-api:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.api
      target: runtime
      args:
        - BUILDKIT_INLINE_CACHE=1
      cache_from:
        - riptide-api:latest
    image: riptide-api:latest
    container_name: riptide-api
    restart: unless-stopped

    ports:
      - "${RIPTIDE_API_PORT:-8080}:8080"

    environment:
      # Core configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # API configuration
      - RIPTIDE_API_HOST=0.0.0.0
      - RIPTIDE_API_PORT=8080
      - RIPTIDE_API_KEY=${RIPTIDE_API_KEY}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-false}

      # Redis connection (uses service name for DNS)
      - REDIS_URL=redis://redis:6379/0

      # Headless browser service (optional)
      - HEADLESS_URL=${HEADLESS_URL:-http://riptide-headless:9123}

      # Spider crawling engine (for deep multi-page site crawling)
      - SPIDER_ENABLE=${SPIDER_ENABLE:-true}

      # Output directories (container paths)
      - RIPTIDE_OUTPUT_DIR=/opt/riptide/data
      - RIPTIDE_CACHE_DIR=/opt/riptide/cache
      - RIPTIDE_LOGS_DIR=/opt/riptide/logs

      # Search configuration
      - SEARCH_BACKEND=${SEARCH_BACKEND:-serper}
      - SERPER_API_KEY=${SERPER_API_KEY}

      # LLM configuration (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Resource limits
      - RIPTIDE_MAX_CONCURRENT_REQUESTS=${RIPTIDE_MAX_CONCURRENT_REQUESTS:-100}
      - RIPTIDE_POOL_SIZE=${RIPTIDE_POOL_SIZE:-10}

    # Optional: Load additional config from .env if it exists
    # Most users don't need this - all critical defaults are set above
    # env_file:
    #   - .env

    volumes:
      # Persistent data volumes (managed by Docker)
      - riptide-data:/opt/riptide/data
      - riptide-cache:/opt/riptide/cache
      - riptide-logs:/opt/riptide/logs

      # Optional: Override config with custom settings
      # Uncomment to use custom configuration
      # - ./config:/opt/riptide/config:ro

    networks:
      - riptide-network

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    labels:
      - "description=RipTide Distributed - Full production deployment"
      - "use_case=Production, high-volume workloads, JavaScript rendering"
      - "deployment_mode=distributed"
      - "cache=redis"
      - "workers=enabled"
      - "browser=chrome-pool"
      - "scaling=horizontal"


  # =========================================================================
  # Redis - Caching and session storage
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: riptide-redis
    restart: unless-stopped

    ports:
      - "${REDIS_PORT:-6379}:6379"

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru

    volumes:
      - redis-data:/data

    networks:
      - riptide-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M


  # =========================================================================
  # Headless Browser Service - For JavaScript-heavy pages
  # =========================================================================
  riptide-headless:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.headless
      target: runtime
    image: riptide-headless:latest
    container_name: riptide-headless
    restart: unless-stopped

    ports:
      - "${HEADLESS_PORT:-9123}:9123"

    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHROME_BIN=/usr/bin/chromium
      - CHROME_PATH=/usr/bin/chromium
      - CHROME_FLAGS=--no-sandbox --headless --disable-gpu --disable-dev-shm-usage

    networks:
      - riptide-network

    # Chromium requires more shared memory
    shm_size: 2gb

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M


  # =========================================================================
  # Swagger UI - API Documentation
  # =========================================================================
  # swagger-ui (OPTIONAL - uncomment to enable API documentation UI)
  # Adds 132MB overhead - only enable if you need interactive API docs
  # swagger-ui:
  #   image: swaggerapi/swagger-ui:latest
  #   container_name: riptide-swagger-ui
  #   restart: unless-stopped
  #
  #   ports:
  #     - "${SWAGGER_PORT:-8081}:8080"
  #
  #   environment:
  #     - SWAGGER_JSON=/openapi.yaml
  #     - BASE_URL=/docs
  #
  #   volumes:
  #     - ./docs/api/openapi.yaml:/openapi.yaml:ro
  #
  #   networks:
  #     - riptide-network
  #   depends_on:
  #     - riptide-api


# =============================================================================
# Networks
# =============================================================================
networks:
  riptide-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16


# =============================================================================
# Volumes - Persistent storage
# =============================================================================
volumes:
  riptide-data:
    driver: local
  riptide-cache:
    driver: local
  riptide-logs:
    driver: local
  redis-data:
    driver: local
