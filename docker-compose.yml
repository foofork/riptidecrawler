# ============================================================================
# RipTide - Docker Compose Configuration
# ============================================================================
# Simple deployment with optional Redis.
#
# Quick Start (No Redis):
#   docker-compose up -d
#
# Quick Start (With Redis):
#   docker-compose --profile redis up -d
#
# Stop:
#   docker-compose down
# ============================================================================

services:
  # =========================================================================
  # RipTide API - Core web scraping and extraction service
  # Native build only (no WASM)
  # =========================================================================
  riptide-api:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.api
      target: runtime
      args:
        - BUILDKIT_INLINE_CACHE=1
      cache_from:
        - riptide-api:latest
    image: riptide-api:latest
    container_name: riptide-api
    restart: unless-stopped

    ports:
      - "${RIPTIDE_API_PORT:-8080}:8080"

    environment:
      # Core configuration
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=${RUST_BACKTRACE:-1}

      # API configuration
      - RIPTIDE_API_HOST=0.0.0.0
      - RIPTIDE_API_PORT=8080
      - RIPTIDE_API_KEY=${RIPTIDE_API_KEY}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-false}

      # Cache backend (memory or redis)
      # Set to "redis" and enable redis profile to use Redis
      - CACHE_BACKEND=${CACHE_BACKEND:-memory}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}

      # Headless browser service (optional)
      - HEADLESS_URL=${HEADLESS_URL:-http://riptide-headless:9123}

      # Spider crawling engine
      - SPIDER_ENABLE=${SPIDER_ENABLE:-true}

      # Output directories (container paths)
      - RIPTIDE_OUTPUT_DIR=/opt/riptide/data
      - RIPTIDE_CACHE_DIR=/opt/riptide/cache
      - RIPTIDE_LOGS_DIR=/opt/riptide/logs

      # Search configuration
      - SEARCH_BACKEND=${SEARCH_BACKEND:-serper}
      - SERPER_API_KEY=${SERPER_API_KEY}

      # LLM configuration (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Resource limits
      - RIPTIDE_MAX_CONCURRENT_REQUESTS=${RIPTIDE_MAX_CONCURRENT_REQUESTS:-100}
      - RIPTIDE_POOL_SIZE=${RIPTIDE_POOL_SIZE:-10}

    volumes:
      # Persistent data volumes (managed by Docker)
      - riptide-data:/opt/riptide/data
      - riptide-cache:/opt/riptide/cache
      - riptide-logs:/opt/riptide/logs

    networks:
      - riptide-network

    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M


  # =========================================================================
  # Redis - OPTIONAL caching and session storage
  # Enable with: docker-compose --profile redis up -d
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: riptide-redis
    restart: unless-stopped
    profiles: ["redis"]

    ports:
      - "${REDIS_PORT:-6379}:6379"

    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru

    volumes:
      - redis-data:/data

    networks:
      - riptide-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M


  # =========================================================================
  # Headless Browser Service - For JavaScript-heavy pages
  # =========================================================================
  riptide-headless:
    build:
      context: .
      dockerfile: infra/docker/Dockerfile.headless
      target: runtime
    image: riptide-headless:latest
    container_name: riptide-headless
    restart: unless-stopped

    ports:
      - "${HEADLESS_PORT:-9123}:9123"

    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CHROME_BIN=/usr/bin/chromium
      - CHROME_PATH=/usr/bin/chromium
      - CHROME_FLAGS=--no-sandbox --headless --disable-gpu --disable-dev-shm-usage

    networks:
      - riptide-network

    # Chromium requires more shared memory
    shm_size: 2gb

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M


# =============================================================================
# Networks
# =============================================================================
networks:
  riptide-network:
    driver: bridge


# =============================================================================
# Volumes - Persistent storage
# =============================================================================
volumes:
  riptide-data:
    driver: local
  riptide-cache:
    driver: local
  riptide-logs:
    driver: local
  redis-data:
    driver: local
